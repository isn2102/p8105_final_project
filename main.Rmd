---
title: "Community Gardens Map"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}

library(tidyverse)
library(plotly)
library(leaflet)
library(ggridges)

#Set global theme for plots
theme_set(theme_minimal() + 
            theme(legend.position = "bottom", 
                  axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)))
#Set options for all plots
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```


```{r include=FALSE}
garden =
  read_csv("./data/final_df.csv") %>%
  group_by(community_board) %>%
  select(community_board, borough, overall_pop, race_white:college_higher, garden_name:longitude)

garden_num = 
  garden %>% 
  drop_na(garden_name) %>% 
  group_by(community_board) %>% 
  summarize(garden_num = n())

garden_tidy = 
  left_join(garden, garden_num, by = "community_board")

```


### Garden Locations around NYC 

```{r, echo = FALSE, warning = FALSE}
leafIcons <- icons(
  iconUrl = ifelse(garden_tidy$size > 0.55,
    "http://leafletjs.com/examples/custom-icons/leaf-orange.png",
    "http://leafletjs.com/examples/custom-icons/leaf-green.png"
  ),
  iconWidth = 20, iconHeight = 30,
  iconAnchorX = 22, iconAnchorY = 94,
)

garden_tidy %>%
   mutate(
    click_label =
      str_c("<b>", garden_name, "</b><br>", borough, "</b><br>", size, " acres")) %>% 
  leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addMarkers(~longitude, ~latitude, icon = leafIcons, popup = ~click_label)

```

**Questions** 
  * If you guys hate the leaf icons I can change it to normal points :-)



### Number of gardens in each Community Board

```{r, echo = FALSE, warning = FALSE}
number_borough = 
  garden_tidy %>% 
  select(community_board, garden_num, borough) %>% 
  distinct() %>% 
  mutate(
    community_board = as.factor(community_board)
  )

x_layout = list(
  title = "Community Board",
  tickmode = "linear"
)

y_layout = list(
  title = "Number of Community Gardens",
  dtick = 5
)

number_borough[is.na(number_borough)] <- 0 

number_borough %>%
  mutate(community_board = fct_reorder(community_board, garden_num),
         text_label = str_c("Number of Gardens: ", garden_num, "\nBorough: ", borough)) %>% 
  plot_ly(
    x = ~community_board, y = ~garden_num, text = ~text_label, color = ~borough, 
    type = "bar", colors = "viridis"
  ) %>% 
  layout(xaxis = x_layout, yaxis = y_layout, title = "Number of Gardens by Community Board")
```
**Question** Why won't factor reorder work? 


### Proportion of difference Races by Community Board

```{r, echo = FALSE, warning = FALSE}

race_tidy = 
  garden_tidy %>% 
  select(community_board, borough, garden_num, race_white:race_other) %>% 
  distinct() %>% 
  pivot_longer(
      race_white:race_other,
      names_to = "race",
      values_to = "proportions"
    )

race_white = 
  race_tidy %>% 
  filter(race == "race_white") %>% 
  group_by(community_board, race) %>% 
  mutate(community_board = fct_reorder(community_board, proportions)) %>% 
  ggplot(aes(x = community_board, y = proportions,  color = borough)) +
      geom_point() +
      geom_segment(aes(x = community_board, xend = community_board, y = 0, yend = proportions))

race_white_ply = ggplotly(race_white)

race_black = 
  race_tidy %>% 
  filter(race == "race_black") %>% 
  group_by(community_board, race) %>% 
  mutate(community_board = fct_reorder(community_board, proportions)) %>% 
  ggplot(aes(x = community_board, y = proportions,  color = borough)) +
      geom_point() +
      geom_segment(aes(x = community_board, xend = community_board, y = 0, yend = proportions))

race_black_ply = ggplotly(race_black)

race_asian = 
  race_tidy %>% 
  filter(race == "race_asian") %>% 
  group_by(community_board, race) %>% 
  mutate(community_board = fct_reorder(community_board, proportions)) %>% 
  ggplot(aes(x = community_board, y = proportions,  color = borough)) +
      geom_point() +
      geom_segment(aes(x = community_board, xend = community_board, y = 0, yend = proportions))

race_asian_ply = ggplotly(race_asian)

race_latino = 
  race_tidy %>% 
  filter(race == "race_latino") %>% 
  group_by(community_board, race) %>% 
  mutate(community_board = fct_reorder(community_board, proportions)) %>% 
  ggplot(aes(x = community_board, y = proportions,  color = borough)) +
      geom_point() +
      geom_segment(aes(x = community_board, xend = community_board, y = 0, yend = proportions))

race_latino_ply = ggplotly(race_latino)

race_fig <- subplot(race_white_ply, race_black_ply, race_asian_ply, race_latino_ply, nrows = 4)
race_fig
```


```{r include = FALSE}

## Using plot-ly instead 
race_white = 
  race_tidy %>% 
  filter(race == "race_white") %>% 
  group_by(community_board, race) %>% 
  mutate(community_board = fct_reorder(community_board, proportions)) %>% 
  plot_ly(
    x = ~community_board, y = ~proportions, color = ~community_board,
    type = "bar", colors = "viridis"
  )

race_latino = 
  race_tidy %>% 
  filter(race == "race_latino") %>% 
  group_by(community_board, race) %>% 
  mutate(community_board = fct_reorder(community_board, proportions)) %>% 
  ggplot(aes(x = community_board, y = proportions,  color = borough)) +
      geom_point() +
      geom_segment(aes(x = community_board, xend = community_board, y = 0, yend = proportions))

race_latino_ply = ggplotly(race_latino)

race_fig <- subplot(race_white_ply, race_black_ply, race_asian_ply, race_latino_ply, nrows = 2)
race_fig

```


