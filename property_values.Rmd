---
title: "Economic Investment"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    theme: bootstrap
    navbar:
       - { title: "Back to Home", href: index.html, align: right }

---
```{r}
library(tidyverse)
library(magrittr)
library(plotly)
library(leaflet)

#Set global theme for plots
theme_set(theme_minimal() + 
            theme(legend.position = "bottom", 
                  axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)))
#Set options for all plots
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```
  
  
```{r}
property_data =
  read_csv("./data/final_df.csv") %>%
  select(community_board, borough, overall_pop, poverty, rent_burden, garden_name, avg_org_value, avg_rev_value, avg_tot_appropriated, latitude, longitude) %>% 
  mutate(value_diff = avg_rev_value - avg_org_value)

num_gardens = 
  property_data %>% 
  drop_na(garden_name) %>% 
  group_by(community_board) %>% 
  summarize(garden_num = n())

unique_comboard =
  property_data %>% 
  distinct(community_board, .keep_all = TRUE)

property_data_final =
  left_join(unique_comboard, num_gardens, by = "community_board") %>% 
  select(-garden_name)
  
```

Column {data-width=500}
-----------------------------------------------------------------------
    
### Distribution of Gardens by Budget Allocation
    
```{r}

css_fix <- "div.info.legend.leaflet-control br {clear: both;}" # CSS to correct spacing
html_fix <- htmltools::tags$style(type = "text/css", css_fix)  # Convert CSS to HTML

pal <- colorNumeric(
  palette = "viridis",
  domain = property_data$avg_tot_appropriated)

property_data %>%
  mutate(
    click_label =
      str_c("<b>", garden_name, "</b><br>Budget: $", avg_tot_appropriated)) %>% 
  leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addCircleMarkers(~longitude, ~latitude, radius = .1, color = ~pal(avg_tot_appropriated), popup = ~click_label) %>% 
  addLegend("topleft", pal = pal, values = ~avg_tot_appropriated,
            title = "Budget Allocation",
            labFormat = labelFormat(prefix = "$"),
            opacity = 1) %<>% htmlwidgets::prependContent(html_fix)
```

> Visualization of the distribution of community gardens in New York City, colored by budget allocated to each community board.

Column {.tabset .tabset-fade data-width=500}
-----------------------------------------------------------------------
   
### Distribution of Gardens by Market Value

```{r}
pal2 <- colorNumeric(
  palette = "viridis",
  domain = property_data$avg_rev_value)

property_data %>%
  mutate(
    click_label =
      str_c("<b>", garden_name, "</b><br>Market Value: $", avg_rev_value)) %>% 
  leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addCircleMarkers(~longitude, ~latitude, radius = .1, color = ~pal2(avg_rev_value), popup = ~click_label) %<>%
    addLegend("topleft", pal = pal2, values = ~avg_rev_value,
            title = "Revised Market Value (Biannually)",
            labFormat = labelFormat(prefix = "$"),
            opacity = 1)

```   

> Visualization of the distribution of community gardens in New York City, colored by average revised market value in each community board, which is updated twice a year (most recently, Feb 2020).

### Distribution of Gardens by Poverty
    
```{r}
pal3 <- colorNumeric(
  palette = "viridis",
  domain = property_data$poverty)

property_data %>%
  mutate(
    click_label =
      str_c("<b>", garden_name, "</b><br>Percent Poverty: ", poverty, "%")) %>% 
  leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addCircleMarkers(~longitude, ~latitude, radius = .1, color = ~pal3(poverty), popup = ~click_label) %>% 
    addLegend("topleft", pal = pal3, values = ~poverty,
            title = "Percent Poverty",
            labFormat = labelFormat(suffix = "%"),
            opacity = 1)

```

> Visualization of the distribution of community gardens in New York City, colored by average percent poverty in each community board location.

### Distribution of Gardens by Rent Burden

```{r}
pal4 <- colorNumeric(
  palette = "viridis",
  domain = property_data$rent_burden)

property_data %>%
  mutate(
    click_label =
      str_c("<b>", garden_name, "</b><br>Percent of Income Spent on Rent: ", rent_burden, "%")) %>% 
  leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addCircleMarkers(~longitude, ~latitude, radius = .1, color = ~pal4(rent_burden), popup = ~click_label) %>% 
    addLegend("topleft", pal = pal4, values = ~rent_burden,
            title = "Percent of Income Spent on Rent",
            labFormat = labelFormat(suffix = "%"),
            opacity = 1)

```

> Visualization of the distribution of community gardens in New York City, colored by average percent of monthly income spent on rent in each community board location.

