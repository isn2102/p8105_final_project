---
title: "Statistical Analysis"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include = FALSE}
library(tidyverse)
library(sandwich)
library(spdep)
library(maptools)
library(rgdal)
library(spatialreg)
library(patchwork)
library(modelr)
library(tmap)
library(corpcor)
library(leaflet)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
set.seed(1)
```

### Analysis theoretical background

To answer the question of how the presence of community gardens is related to economic investment and health outcomes, we decided to build linear regression models using the number of gardens in each community district as the main predictor of interest. We began the process by selecting specific outcome variables that we hypothesized might be influenced by the number of gardens in a community district, informed by prior literature. The studies and articles we reviewed suggested that access to green space and gardens was beneficial for health, and that community gardens may also positively impact community engagement and the perceived value of the neighborhood. The following sources guided our thinking and hypothesis generation:   
1. [Community gardens and community activism](https://www.pps.org/article/beyond-food-community-gardens-as-places-of-connection-and-empowerment)  
2. [Urban green space and health](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2566234/pdf/587.pdf)  
3. [Obesity and green space](https://doi.org/10.1093/eurpub/ckx037)  
4. [Community gardening and communal resilience](https://doi.org/10.3390/ijerph17186740)  
5. [Neighborhood perceptions and hypertension](https://doi.org/10.1186/s12889-016-3741-2)  

We initially selected the following variables as outcomes to explore with linear regression:    
**Health outcomes**  
1. Obesity  
  - Hypothesis: A higher number of community gardens in a district will be associated with a lower percentage of obese adults in the district.   
2. Hypertension  
  - Hypothesis: A higher number of community gardens in a district will be associated with a lower percentage of adults reporting hypertension in the district.   
3. Life expectancy  
  -Hypothesis: A higher number of community gardens in a district will be associated with a higher average life expectancy in the district.   
4. Self-reported health  
  -Hypothesis: A higher number of community gardens in a district will be associated with a higher percentage of adults in the district reporting good health.   

**Economic outcomes**  
1. Money allocated to project through a participatory budgeting process  
  -Hypothesis: A higher number of community gardens in a district will be associated with greater amounts of money allocated by the community through participatory budgeting processes.  
2. Average market value of buildings   
  -Hypothesis: A higher number of community gardens in a district will be associated with higher average property market values.   
  
**Confounders**   
Given that community gardens were historically formed in empty lots that resulted from abandoned buildings and that poverty also impacts health and perceived neighborhood value, we hypothesized that percent poverty in the neighborhood would be a confounder of all the above relationships.  

We had to remove one community district that didn't have any neighbors because in order to successfully run the spatial regression all community districts have to have neighbors.
```{r, message = FALSE, warning = FALSE, include = FALSE}
analysis_data_final <-
  read_csv("./data/final_df.csv") %>% 
  select(id_spatial, community_board, obesity, hypertension, life_expectancy, self_rep_health, poverty, avg_rev_value, avg_tot_appropriated, borough, garden_num) %>% 
filter(!id_spatial %in% c('414'))
         
working <- getwd()
com_board_spdf <- readOGR(dsn = working, layer = "community_board_new")
com_board_spdf2 <- com_board_spdf[!com_board_spdf@data$boro_cd %in% c("414"), ]
names(com_board_spdf)
analysis_data_spatial <- merge(com_board_spdf2, analysis_data_final, by.x = "boro_cd", by.y = "id_spatial")
```

### Variable operationalization
1. Number of gardens per community district 
2. Percentage of adults ages 18 and older who have obesity (Body Mass Index of 30 or greater) based on self-reported height and weight.  
3. Percentage of adults ages 18 and older who report ever being told by a healthcare professional that they have hypertension.  
4. Life expectancy at birth.  
5. Percentage of adults ages 18 and older who report their overall health is “excellent,” “very good” or “good” on a scale of excellent, very good, good, fair or poor.  
6. Total amount of funding for projects allocated by participatory budgeting in a community board.  
7. Average revised market value of properties in each community board.  
8. Percentage of residents living below 100% of NYC’s calculated poverty threshold, based on income and necessary expenses.  

### Linear regression assumptions
**Linearity of predictor/outcome relationship and Homoscedasticity**  
We first checked linearity of the relationship between garden number / poverty and the potential outcome. Most outcomes have a vaguely linear association, however it appears that the variance is not constant (heteroscedasticity), which we will address by looking at residuals after fitting our model. We tried transforming x (garden number) with a log transformation so that it would be a more linear relationship, but this resulted in an eventual error later in the analysis when doing spatial regression. Average revised market value does not seem to have a linear relationship at all, so we did not move forward with this outcome. 
```{r, message = FALSE, warning = FALSE}
poverty_plot <-
analysis_data_final %>% 
  ggplot(aes(x = garden_num, y = poverty)) +
  geom_point()

obesity_plot <-
analysis_data_final %>% 
  ggplot(aes(x = garden_num, y = obesity)) +
  geom_point()

hypertension_plot <-
analysis_data_final %>% 
  ggplot(aes(x = garden_num, y = hypertension)) +
  geom_point()

life_plot <-
analysis_data_final %>% 
  ggplot(aes(x = garden_num, y = life_expectancy)) +
  geom_point()

self_health_plot <-
analysis_data_final %>% 
  ggplot(aes(x = garden_num, y = self_rep_health)) +
  geom_point()

avg_rev_plot <-
analysis_data_final %>% 
  ggplot(aes(x = garden_num, y = avg_rev_value)) +
  geom_point()

avg_appr_plot <-
analysis_data_final %>% 
  ggplot(aes(x = garden_num, y = avg_tot_appropriated)) +
  geom_point()

obesity_poverty <-
analysis_data_final %>% 
  ggplot(aes(x = poverty, y = obesity)) +
  geom_point()

hypertension_poverty <-
analysis_data_final %>% 
  ggplot(aes(x = poverty, y = hypertension)) +
  geom_point()

life_poverty <-
analysis_data_final %>% 
  ggplot(aes(x = poverty, y = life_expectancy)) +
  geom_point()

self_health_poverty <-
analysis_data_final %>% 
  ggplot(aes(x = poverty, y = self_rep_health)) +
  geom_point()

avg_rev_poverty <-
analysis_data_final %>% 
  ggplot(aes(x = poverty, y = avg_rev_value)) +
  geom_point()

avg_appr_poverty <-
analysis_data_final %>% 
  ggplot(aes(x = poverty, y = avg_tot_appropriated)) +
  geom_point()

poverty_plot + avg_appr_plot + avg_rev_plot + life_plot + obesity_plot + hypertension_plot + self_health_plot + avg_appr_poverty + avg_rev_poverty + life_poverty + obesity_poverty + hypertension_poverty + self_health_poverty + plot_layout(ncol = 5)
```

**Normal distribution of variables**  
Our next assumption check was the normal distribution of outcome variables. Because we are using some variables that are percentages and not technically continuous, we wanted to ensure they were relatively normally distributed in order to move forward. All variables are mostly normally distributed.  
```{r, message = FALSE, warning = FALSE}

garden_density <-
analysis_data_final %>% 
  ggplot(aes(x = garden_num)) +
  geom_density()

pov_density <-
analysis_data_final %>% 
  ggplot(aes(x = poverty)) +
  geom_density()

obes_density <-
analysis_data_final %>% 
  ggplot(aes(x = obesity)) +
  geom_density()

hypert_density <-
analysis_data_final %>% 
  ggplot(aes(x = hypertension)) +
  geom_density()

life_exp_density <-
analysis_data_final %>% 
  ggplot(aes(x = life_expectancy)) +
  geom_density()

self_health_density <-
analysis_data_final %>% 
  ggplot(aes(x = self_rep_health)) +
  geom_density()

tot_appr_density <-
analysis_data_final %>% 
  ggplot(aes(x = avg_tot_appropriated)) +
  geom_density()

pov_density + tot_appr_density + life_exp_density + obes_density + hypert_density + self_health_density + plot_layout(ncol = 3)

```

**No auto-correlation**  
From our initial visual exploration, we suspected that there would be substantial auto-correlation as it appears that [number of gardens](main.html), [economic variables](property_values.html), and [health outcome variables](health.html) are all clustered in space. 

To test for spatial auto-correlation of variables beyond our visual assessment we used Moran's I. We created a queen's neighborhood spatial weight matrix for these calculations. A significant Moran's I indicates the values are clustered and are not independent. We found that the Moran's I was significant at the 1% level for garden number, obesity, hypertension, life expectancy, and self-reported health. We were not able to calculate Moran's I for budget allocation because of too many missing values. Because we see significant spatial auto-correlation this indicates that we should adjust for a spatial parameter in our regression model. 

```{r}
###Create a queen's neighborhood weight matrix using the poly2nb command.
analysis_nbq <- poly2nb(analysis_data_spatial)

###extract coordinates to plot the connectivity matrix for visualization.
coords <- coordinates(analysis_data_spatial)

###convert the neighborhood matrix into a list so that the connections between counties can be used in Moran's I test.
analysis_nbq_w <- nb2listw(analysis_nbq)

###Garden number
###Convert Exposure variable to z-form and then create the lag of that variable.
analysis_data_spatial@data$garden_num <- scale(analysis_data_spatial@data$garden_num)
analysis_data_spatial@data$lag_sQL <- lag.listw(analysis_nbq_w,analysis_data_spatial@data$garden_num)

### Lose spatial properties when we turn into data frame for analysis
#analysis_sp_data <- as.data.frame(analysis_data_spatial)

###Run morans I test and plot the results.
garden_moran <- moran.test(analysis_data_spatial@data$garden_num, listw = analysis_nbq_w, zero.policy = TRUE)
moran.plot(as.vector(analysis_data_spatial@data$garden_num), listw = analysis_nbq_w, 
           xlim = c(-2,4),ylim = c(-2,2),
                 main = "Moran's I = 0.1899, p-value = 0.0138", 
           xlab = "Garden Number", ylab = "Spatial Lag Number of Gardens", pch = 19)
```

```{r}
###Obesity
###Convert outcome variable to z-form and then create the lag of that variable.
analysis_data_spatial@data$obesity <- scale(analysis_data_spatial@data$obesity)
analysis_data_spatial@data$lag_sQL_o <- lag.listw(analysis_nbq_w,analysis_data_spatial@data$obesity)

### Lose spatial properties when we turn into data frame for analysis
#analysis_sp_data <- as.data.frame(analysis_data_spatial)

###Run morans I test and plot the results.
obesity_moran <- moran.test(analysis_data_spatial@data$obesity, listw = analysis_nbq_w, zero.policy = TRUE)
moran.plot(as.vector(analysis_data_spatial@data$obesity), listw = analysis_nbq_w, 
           xlim = c(-2,4),ylim = c(-2,2),
                 main = "Moran's I = 0.7075, p-value < 0.0001", 
           xlab = "Obesity", ylab = "Spatial Lag Obesity", pch = 19)
```

```{r}
###hypertension
###Convert Exposure variable to z-form and then create the lag of that variable.
analysis_data_spatial@data$hypertension <- scale(analysis_data_spatial@data$hypertension)
analysis_data_spatial@data$lag_sQL_ht <- lag.listw(analysis_nbq_w,analysis_data_spatial@data$hypertension)

### Lose spatial properties when we turn into data frame for analysis
#analysis_sp_data <- as.data.frame(analysis_data_spatial)

###Run morans I test and plot the results.
hypertension_moran <- moran.test(analysis_data_spatial@data$hypertension, listw = analysis_nbq_w, zero.policy = TRUE)
moran.plot(as.vector(analysis_data_spatial@data$hypertension), listw = analysis_nbq_w, 
           xlim = c(-2,4),ylim = c(-2,2),
                 main = "Moran's I = 0.5792, p-value < 0.0001", 
           xlab = "Hypertension", ylab = "Spatial Lag Hypertension", pch = 19)
```

```{r}
###Life Expectancy
###Convert outcome variable to z-form and then create the lag of that variable.
analysis_data_spatial@data$life_expectancy <- scale(analysis_data_spatial@data$life_expectancy)
analysis_data_spatial@data$lag_sQL_l <- lag.listw(analysis_nbq_w,analysis_data_spatial@data$life_expectancy)

### Lose spatial properties when we turn into data frame for analysis
#analysis_sp_data <- as.data.frame(analysis_data_spatial)

###Run morans I test and plot the results.
life_moran <- moran.test(analysis_data_spatial@data$life_expectancy, listw = analysis_nbq_w, zero.policy = TRUE)
moran.plot(as.vector(analysis_data_spatial@data$life_expectancy), listw = analysis_nbq_w, 
           xlim = c(-2,4),ylim = c(-2,2),
                 main = "Moran's I = 0.5354, p-value < 0.0001", 
           xlab = "Life Expectancy", ylab = "Spatial Lag Life Expectancy", pch = 19)
```

```{r}
###Self Reported Health 
###Convert outcome variable to z-form and then create the lag of that variable.
analysis_data_spatial@data$self_rep_health <- scale(analysis_data_spatial@data$self_rep_health)
analysis_data_spatial@data$lag_sQL_sh <- lag.listw(analysis_nbq_w,analysis_data_spatial@data$self_rep_health)

### Lose spatial properties when we turn into data frame for analysis
#analysis_sp_data <- as.data.frame(analysis_data_spatial)

###Run morans I test and plot the results.
self_health_moran <- moran.test(analysis_data_spatial@data$self_rep_health, listw = analysis_nbq_w, zero.policy = TRUE)
moran.plot(as.vector(analysis_data_spatial@data$self_rep_health), listw = analysis_nbq_w, 
           xlim = c(-2,4),ylim = c(-2,2),
                 main = "Moran's I = 0.2817, p-value = 0.0012", 
           xlab = "Self Reported Health", ylab = "Spatial Lag Self Reported Health", pch = 19)
```

**No or little multicollinearity** 
This correlation plot displays the correlation between all variables. Regarding regression assumptions we care about the explanatory variables not being too highly correlated with each other. We see that the correlation coefficient between garden number and poverty (the two explanatory variables) is only 0.32, which is not very high. 

```{r}
analysis_data_final %>% 
  select(garden_num, obesity, hypertension, self_rep_health, life_expectancy, poverty) %>% 
  cor() %>% 
  corrplot::corrplot(type = "lower",
                     method = "square", 
                     addCoef.col = "black", 
                     diag = FALSE, 
                     number.cex = .6,
                     tl.col = "black",
                     tl.cex = .9,
                     tl.srt = 45)
```


### Fitting a model 
**Basic linear model**  
Based on our determination of spatial auto-correlation, we decided to fit spatial regression models. We first fit general linear models and then ran Lagrane Multiplier tests on these to identify the appropriate type of spatial regression model to use. We found that the robust lagrange multiplier lag was significant for the obesity, hypertension, and life expectancy models. None of the lagrange multipliers were significant for self-reported health, indicating that we can run a regular linear regression model.  
```{r}
###fit baseline linear models.
obesity_lm <- lm(obesity ~ garden_num + poverty, data = analysis_data_spatial)
hypertension_lm <- lm(hypertension ~ garden_num + poverty, data = analysis_data_spatial)
life_expectancy_lm <- lm(life_expectancy ~ garden_num + poverty, data = analysis_data_spatial)
self_rep_health_lm <- lm(self_rep_health ~ garden_num + poverty, data = analysis_data_spatial)

obesity_lagrange <- lm.LMtests(obesity_lm, analysis_nbq_w, test = c("LMerr","RLMerr","LMlag","RLMlag","SARMA"))
hypertension_lagrange <- lm.LMtests(hypertension_lm, analysis_nbq_w, test = c("LMerr","RLMerr","LMlag","RLMlag","SARMA"))
life_expectancy_lagrange <- lm.LMtests(life_expectancy_lm,analysis_nbq_w, test = c("LMerr","RLMerr","LMlag","RLMlag","SARMA"))
self_rep_lagrange <- lm.LMtests(self_rep_health_lm, analysis_nbq_w, test = c("LMerr","RLMerr","LMlag","RLMlag","SARMA"))

```

**Final regression models**  
```{r}
###Specify Spatial Lag Model for obesity
obesity_lag <- lagsarlm(obesity ~ garden_num + poverty, data = analysis_data_spatial, analysis_nbq_w, tol.solve = 1.0e-15)
obesity_lag_df <-
obesity_lag %>% 
  broom::tidy() %>% 
  mutate(
    model = "obesity") %>% 
  relocate(model)

###Specify Spatial Lag Model for hypertension
hypertension_lag <- lagsarlm(hypertension ~ garden_num + poverty, data = analysis_data_spatial, analysis_nbq_w, tol.solve = 1.0e-15)
hypertension_lag_df <-
hypertension_lag %>% 
  broom::tidy() %>% 
  mutate(
    model = "hypertension") %>% 
  relocate(model)

###Specify Spatial Lag Model for life expectancy
life_expect_lag <- lagsarlm(life_expectancy ~ garden_num + poverty, data = analysis_data_spatial, analysis_nbq_w, tol.solve = 1.0e-15)
life_expect_lag_df <-
life_expect_lag %>% 
  broom::tidy() %>% 
  mutate(
    model = "life expectancy") %>% 
  relocate(model)

###Specify regular linear regression model for self-reported health
self_rep_lm <- lm(self_rep_health ~ garden_num + poverty, data = analysis_data_spatial)
self_rep_lm_df <-
self_rep_lm %>% 
  broom::tidy() %>% 
  mutate(
    model = "self reported health") %>% 
  relocate(model)

```

```{r}
rbind(obesity_lag_df, hypertension_lag_df, life_expect_lag_df, self_rep_lm_df) %>% 
  knitr::kable()
```

### Revisiting model diagnostics
Show map of residuals with linear regression and spatial regression. 

```{r}
###Look at residuals for obesity for spatial lag model
analysis_data_spatial$residuals_ob <- residuals(obesity_lag)
analysis_data_spatial$residuals_ob_lm <- residuals(obesity_lm)
#Check that residuals are no longer spatially dependent with the lag model 
resid_moran <- moran.mc(analysis_data_spatial$residuals_ob, analysis_nbq_w, 999) %>% 
  broom::tidy() %>% 
  select(p.value) %>% 
  mutate(
    model = "obesity")

###Look at map of residuals for spatial lag model for obesity 
pal_1 <- colorNumeric("YlGn", analysis_data_spatial@data$residuals_ob)
leaflet(analysis_data_spatial) %>% 
  addProviderTiles(providers$CartoDB.Positron) %>%  
  setView( lat = 40.7, lng = -74 , zoom = 10) %>%
  addPolygons( 
    fillOpacity = 0.8, 
    smoothFactor = 0.5, 
    fillColor = ~colorQuantile("YlGn", residuals_ob)(residuals_ob), 
    stroke = TRUE, 
    color = "black", 
    weight = 0.3
    ) %>%
  addLegend( pal = pal_1, values = ~residuals_ob, opacity = 0.9, title = "Obesity Residuals Spatial Lag", position = "topleft" )

###Look at map of residuals for regular linear model for obesity 
pal_2 <- colorNumeric("YlGn", analysis_data_spatial@data$residuals_ob_lm)
leaflet(analysis_data_spatial) %>% 
  addProviderTiles(providers$CartoDB.Positron) %>%  
  setView( lat = 40.7, lng = -74 , zoom = 10) %>%
  addPolygons( 
    fillOpacity = 0.8, 
    smoothFactor = 0.5, 
    fillColor = ~colorQuantile("YlGn", residuals_ob_lm)(residuals_ob_lm), 
    stroke = TRUE, 
    color = "black", 
    weight = 0.3
    ) %>%
  addLegend( pal = pal_2, values = ~residuals_ob_lm, opacity = 0.9, title = "Obesity Residuals Linear", position = "topleft" )

```

### Analysis conclusions
Write conclusions here


### Limitations of the model 

- We did 5 hypothesis tests with our five models so to be conservative with our level of type I error we might want to set our alpha to 0.01   
- Small sample size (removed one observation because of no neighbors)  
- Because of small sample we could only adjust for one covariate, but this may not account for all the variance in the model  
- Decided not to transform garden number to make it more of a linear relationship because it introduced issues later in the analysis process, but this may lead to a misspecified model  

### To do
- [Figure out how to do residual plots with spatial data](https://data.library.virginia.edu/diagnostic-plots/) 
- [Another residuals interpretation link](http://www.sthda.com/english/articles/39-regression-model-diagnostics/161-linear-regression-assumptions-and-diagnostics-in-r-essentials/#loading-required-r-packages)
- Figure out how to plot the predicted values on top of the datapoints? 
- Add more maps of the residuals if we want that?  
- Add tables for moran's I no longer significant after spatial models  
- Add tables with the diagnostics for choosing a spatial model  


