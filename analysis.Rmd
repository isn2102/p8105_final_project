---
title: "Statistical Analysis"
output: 
  html_document:
    toc: true
    toc_float: true
---

1. Spatial dependence of gardens (clusters statistically significant / not normally distributed)  
2. Spatial regression model for economic indicators (choose one or two)  
  - Can use property values by interpolating and summarizing at community board level, or median income/gentrification value for each community board, or create a composite variable for average participatory budgeting amount per location  
  - Adjust for covariates: race, age  
3. Spatial regression model for health indicators (choose one or two)  
  - Can use the value for each community board  
  - Adjust for covariates: race, age, income  
  
Notes: 
"Proportion data has values that fall between zero and one. Naturally, it would be nice to have the predicted values also fall between zero and one. One way to accomplish this is to use a generalized linear model (glm) with a logit link and the binomial family. We will include the robust option in the glm model to obtain robust standard errors which will be particularly useful if we have misspecified the distribution family."
- https://stats.idre.ucla.edu/stata/faq/how-does-one-do-regression-when-the-dependent-variable-is-a-proportion/

https://hansjoerg.me/2019/05/10/regression-modeling-with-proportion-data-part-1/ 
  
  
```{r}
library(tidyverse)
library(sandwich)
library(spdep)
library(maptools)
library(rgdal)
library(spatialreg)
```

```{r, message = FALSE, warning = FALSE, include = FALSE}
health_data <-
  read_csv("./data/final_df.csv") %>% 
  select(community_board, garden_name, obesity, hypertension, life_expectancy, self_rep_health, poverty) %>% 
  mutate(duplicate = community_board, 
         spatial_id = community_board, 
         spatial_id = str_replace(spatial_id, "^M", "1"),
         spatial_id = str_replace(spatial_id, "^X", "2"),
         spatial_id = str_replace(spatial_id, "^B", "3"),
         spatial_id = str_replace(spatial_id, "^Q", "4"),
         spatial_id = str_replace(spatial_id, "^R", "5")
         ) %>% 
  separate(duplicate, c("boro", NA), sep = 1) %>% 
  mutate(
    spatial_id = as.numeric(spatial_id)
  )

num_gardens <-
  health_data %>% 
  drop_na(garden_name) %>% 
  group_by(community_board) %>% 
  summarize(garden_num = n())

unique_comboard <-
  health_data %>% 
  distinct(community_board, .keep_all = TRUE)

health_data_final <-
  left_join(unique_comboard, num_gardens, by = "community_board") %>% 
  select(-garden_name) %>% 
  replace_na(list(garden_num = 0)) %>% 
  mutate(
    boro_name = case_when(
      boro == "M" ~ "Manhattan",
      boro == "X" ~ "Bronx",
      boro == "B" ~ "Brooklyn",
      boro == "Q" ~ "Queens",
      boro == "R" ~ "Staten Island"
    )) %>% 
  filter(spatial_id != '414')
  
working <- getwd()
com_board_spdf <- readOGR(dsn = working, layer = "community_board_new")
com_board_spdf2 <- com_board_spdf[com_board_spdf@data$boro_cd != "414", ]
names(com_board_spdf)
health_data_spatial <- merge(com_board_spdf2, health_data_final, by.x = "boro_cd", by.y = "spatial_id")
```

Trying out binomial distribution glm:
```{r, eval = FALSE}
health_glm <-
  health_data_final %>% 
  mutate(
    hypertension = hypertension / 100, 
    poverty = poverty / 100
  )

fitglm <- glm(hypertension ~ garden_num + poverty, family = binomial(logit), data = health_glm)
summary(fitglm)

# Calculate robust standard errors
cov.m1 <- vcovHC(fitglm, type = "HC0")
std.err <- sqrt(diag(cov.m1))
q.val <- qnorm(0.975)
r.est <- cbind(
  Estimate = coef(fitglm)
  , "Robust SE" = std.err
  , z = (coef(fitglm)/std.err)
  , "Pr(>|z|) " = 2 * pnorm(abs(coef(fitglm)/std.err), lower.tail = FALSE)
  , LL = coef(fitglm) - q.val  * std.err
  , UL = coef(fitglm) + q.val  * std.err
)
r.est
```

Detecting non-random distribution: gardens
```{r, eval = FALSE}
###Create a queen's neighborhood weight matrix using the poly2nb command.
health_nbq <- poly2nb(health_data_spatial)

###extract coordinates to plot the connectivity matrix for visualization.
coords <- coordinates(health_data_spatial)
plot(health_data_spatial)
plot(health_nbq, coords, add = T)

###convert the neighborhood matrix into a list so that the connections between counties can be used in Moran's I test.
summary(health_nbq)
health_nbq_w <- nb2listw(health_nbq)

###Convert Exposure variable to z-form and then create the lag of that variable.
health_data_spatial@data$hypertension <- scale(health_data_spatial@data$hypertension)
health_data_spatial@data$lag_sQL <- lag.listw(health_nbq_w,health_data_spatial@data$hypertension)
summary(health_data_spatial@data$hypertension)
summary(health_data_spatial@data$lag_sQL)

### Lose spatial properties when we turn into data frame for analysis
health_sp_data <- as.data.frame(health_data_spatial)
head(health_sp_data)

###Run the morans I test and plot the results. Use the values from the summary of quali_life
###and lag_sql to set the x and y axis range
moran.test(health_data_spatial@data$hypertension, listw = health_nbq_w, zero.policy = TRUE)
moran.plot(as.vector(health_data_spatial@data$hypertension), listw = health_nbq_w, 
           xlim = c(-2,4),ylim = c(-2,2),
                 main = "Moran's I = 0.5729, p-value < 0.0001", 
           xlab = "Hypertension",ylab = "Spatial Lag Number of Gardens",pch = 19)
```

Spatial regression 
Notes - had to remove one community garden that didn't have any neighbors because was getting error when running the spatial regression. This is using linear regression. Need to confirm if this is an appropriate one to use. Also need to confirm which exact spatial model to use, and whether any assumptions violated. Have not done anything with GWR yet. 
```{r, eval = FALSE}
###Test baseline linear model.
hypertension.lm <- lm(hypertension ~ garden_num + poverty, data = health_data_spatial)
summary(hypertension.lm)

###Run Langrane Multiplier tests to identify the type of spatial regression model to run.
htn.lagrange <- lm.LMtests(hypertension.lm,health_nbq_w, test = c("LMerr","RLMerr","LMlag","RLMlag","SARMA"))
print(htn.lagrange)

### GLOBAL MODELS ###

###Specify Spatial Lag Model
htn.lag <- spatialreg::lagsarlm(hypertension ~ garden_num + poverty, data = health_data_spatial, health_nbq_w, tol.solve = 1.0e-15)
###Spatial error model 
htn.err <- spatialreg::errorsarlm(hypertension ~ garden_num + poverty, data = health_data_spatial, health_nbq_w, tol.solve = 1.0e-15)
###Mixed model (SARMA significant)
htn.sar <- spatialreg::lagsarlm(hypertension ~ garden_num + poverty, data = health_data_spatial, health_nbq_w, type = "mixed", tol.solve = 1.0e-15)

summary(htn.lag)
summary(htn.err)
summary(htn.sar)


##### GWR MODEL (GEOGRAPHICALLY WEIGHTED / LOCAL REGRESSION)#################################
library(spgwr)

bwG <- gwr.sel(Quali_Life~TRImean + POV + PBLK, data = health_data_spatial, gweight = gwr.Gauss, verbose = TRUE)
### Run model
gwrG <- gwr(Quali_Life~TRImean + POV + PBLK, data = health_data_spatial, bandwidth = bwG, gweight = gwr.Gauss)

gwrG

names(gwrG)

### Dataframe column with the output from the model 
names(gwrG$SDF)

### Percent of variance explained by the model, plotted
spplot(gwrG$SDF, "localR2")

### Plot relationship between toxic release emissions and quality of life:
spplot(gwrG$SDF, "TRImean")

### Poverty as it relates to quality of life
spplot(gwrG$SDF, "POV")
```


