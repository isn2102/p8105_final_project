---
title: "Statistical Analysis"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include = FALSE}
library(tidyverse)
library(sandwich)
library(spdep)
library(maptools)
library(rgdal)
library(spatialreg)
library(patchwork)
library(modelr)
library(tmap)
library(corpcor)
library(leaflet)
library(knitr)
library(kableExtra)

options(kableExtra.latex.load_packages = F)
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
set.seed(1)
```


```{r, message = FALSE, warning = FALSE}
analysis_data_final <-
  read_csv("./data/final_df.csv") %>% 
  select(id_spatial, community_board, obesity, hypertension, life_expectancy, self_rep_health, poverty, avg_rev_value, avg_tot_appropriated, borough, garden_num) %>% 
filter(!id_spatial %in% c('414'))
         
working <- getwd()
com_board_spdf <- readOGR(dsn = working, layer = "community_board_new", verbose = FALSE)
com_board_spdf2 <- com_board_spdf[!com_board_spdf@data$boro_cd %in% c("414"), ]
invisible(names(com_board_spdf))
analysis_data_spatial <- merge(com_board_spdf2, analysis_data_final, by.x = "boro_cd", by.y = "id_spatial")
```


### **Questions**

1. How are community gardens spatially distributed throughout the city?
2. How are the locations of gardens related to certain demographic characteristics?
3. What is the relationship between community gardens and economic investment? 
4. What is the relationship between community gardens and health conditions? 

### **Exposure of interest and Confounder**

Exposure:

 * Number of gardens in each Community Board 

Confounder:

 * Poverty - percent living below 100% of NYC's calculated poverty threshold based on income and necessary expenses
    
    - Community gardens are historically formed in empty lots/areas of abandoned buildings 
    - Poverty impacts health and perceived neighborhood value

### **Outcomes of Interest** 

#### Health Outcomes

 * Obesity - percent obesity in a community board (BMI > 30)
 * Hypertension - percent of hypertension in a community board (individuals with a diagnosis)
 * Life expectancy - at birth
 * Self reported health - percent of adults reporting health on a scale from "excellent" to "poor"

#### Economic Outcomes

 * Average total appropriated - money allocated through participatory budget processing
    - After assessing the distribution of values, we found that there were too many missing values and chose to not move forward in analyzing this variable.
 * Average Market value of buildings  
    - After assessing the distribution of values, we found that there were too many missing values and chose to not move forward in analyzing this variable.

### **Moran's I**

#### What is it

  A correlation coefficient that measures the overall spatial auto-correlation among nearby locations in space. It measures how similar on object is to          other surrounding it. 

#### Interpretation

 * -1: perfect dispersion (definite pattern)
 * 0: no auto-correlation (perfect randomness, values are dependent on values of nearby areas)
 * +1: perfect clustering of similar values (opposite of dispersion)
 
#### Hypothesis

  We hypothesized that the community gardens in NYC would not be evenly distributed spatially, indicating that the number of gardens in a specific               community board depends on where in NYC you are looking
 
#### What we did

 * We wanted to test if the spatial distribution of the gardens was randomly distributed
 * Created a Queen's neighborhood spatial weight matrix to define spatial neighbors as those community districts which are directly touching
 * Used this to calculate Moran's I using the `spdep` package

#### Results

  We found that *Moran's I = 0.1899 (p=0.0138)*. This confirmed our hypothesis that community gardens in NYC are not evenly distributed spatially.

```{r, message = FALSE, warning = FALSE}
analysis_data_final <-
  read_csv("./data/final_df.csv") %>% 
  select(id_spatial, community_board, obesity, hypertension, life_expectancy, self_rep_health, poverty, avg_rev_value, avg_tot_appropriated, borough, garden_num) %>% 
filter(!id_spatial %in% c('414'))
         
working <- getwd()
com_board_spdf <- readOGR(dsn = working, layer = "community_board_new", verbose = FALSE)
com_board_spdf2 <- com_board_spdf[!com_board_spdf@data$boro_cd %in% c("414"), ]
invisible(names(com_board_spdf))
analysis_data_spatial <- merge(com_board_spdf2, analysis_data_final, by.x = "boro_cd", by.y = "id_spatial")

###Create a queen's neighborhood weight matrix using the poly2nb command.
analysis_nbq <- poly2nb(analysis_data_spatial)

###extract coordinates to plot the connectivity matrix for visualization.
coords <- coordinates(analysis_data_spatial)

###convert the neighborhood matrix into a list so that the connections between counties can be used in Moran's I test.
analysis_nbq_w <- nb2listw(analysis_nbq)

###Garden number
###Convert Exposure variable to z-form and then create the lag of that variable.
analysis_data_spatial@data$garden_num <- scale(analysis_data_spatial@data$garden_num)
analysis_data_spatial@data$lag_sQL <- lag.listw(analysis_nbq_w,analysis_data_spatial@data$garden_num)

### Lose spatial properties when we turn into data frame for analysis
#analysis_sp_data <- as.data.frame(analysis_data_spatial)

###Run morans I test and plot the results.
garden_moran <- moran.test(analysis_data_spatial@data$garden_num, listw = analysis_nbq_w, zero.policy = TRUE)
moran.plot(as.vector(analysis_data_spatial@data$garden_num), listw = analysis_nbq_w, 
           xlim = c(-2,4),ylim = c(-2,2),
                 main = "Moran's I = 0.1899, p-value = 0.0138", 
           xlab = "Garden Number", ylab = "Spatial Lag Number of Gardens", pch = 19)
```


### **Choosing a model**

#### Linear Regression 

 * Initially we intended to run a linear regression model because of ease of interpretation and flexibility with the model
 * Assessing linear model assumptions (see [report](report.html) for more information on this)
    * Normal distribution 
      - All variables were generally normally distributed
    * Linearity and Homoscedasticity
      - While most associations appear linear, *the variance does not appear constant* 
      - We will address lack of constant variance by looking at residuals after fitting our model
    * Multicollinearity
      - We wanted to ensure that the correlation coefficient between garden number and poverty (2 covariates) was not high
      - We found that *r = 0.32, assuring us that our 2 covariates are not highly correlated*
    * Auto-correlation
      - We needed to ensure that all observations are independent to meet linear regression assumptions
      - Based on our map visualizations, we suspected that there would be substantial auto-correlation  as it appears that [number of gardens](main.html), [economic variables](property_values.html), and [health outcome variables](health.html) are all clustered in space. 
      - We used Moran's I spatial auto-correlation for each outcome 
      - *We found Moran's I was significant for obesity, hypertension, life expectancy and self-reported health (they are not evenly distributed spatially across NYC)*
      - **We decided to adjust for a spatial parameter in our linear regression model to account for the significant auto-correlation**

#### Spatial Diagnostics

  We fit general linear regression models and ran Lagrange Multiplier tests on these to identify the appropriate type of spatial regression model to use.        The Lagrange Multiplier test statistics allow us to observe a distinction between spatial error models and spatial lag models. See flow chart below for        our thought process: 

![](images/spatial_model.jpeg){ height="400px" width="300px" }
[Image source](https://rpubs.com/quarcs-lab/tutorial-spatial-regression)

```{r, message = FALSE, warning = FALSE}
###fit baseline linear models.
obesity_lm <- lm(obesity ~ garden_num + poverty, data = analysis_data_spatial)
hypertension_lm <- lm(hypertension ~ garden_num + poverty, data = analysis_data_spatial)
life_expectancy_lm <- lm(life_expectancy ~ garden_num + poverty, data = analysis_data_spatial)
self_rep_health_lm <- lm(self_rep_health ~ garden_num + poverty, data = analysis_data_spatial)

obesity_lagrange <- lm.LMtests(obesity_lm, analysis_nbq_w, test = c("LMerr","RLMerr","LMlag","RLMlag","SARMA"))
hypertension_lagrange <- lm.LMtests(hypertension_lm, analysis_nbq_w, test = c("LMerr","RLMerr","LMlag","RLMlag","SARMA"))
life_expectancy_lagrange <- lm.LMtests(life_expectancy_lm,analysis_nbq_w, test = c("LMerr","RLMerr","LMlag","RLMlag","SARMA"))
self_rep_lagrange <- lm.LMtests(self_rep_health_lm, analysis_nbq_w, test = c("LMerr","RLMerr","LMlag","RLMlag","SARMA"))

lagrange_df <-
  tibble(
    model_outcome = c("Obesity", "Hypertension", "Life Expectancy", "Self Reported Health"), 
    LMerror_pvalue = c(0.0000145, 0.0002054, 0.000027, 0.6988), 
    robust_LMerror_pvalue = c(0.3705, 0.3374, 0.6854, 0.6328), 
    LMlag_pvalue = c(0.0000000046, 0.0000019, 0.00000075, 0.9243), 
    robust_LMlag_pvalue = c(0.000067, 0.001757, 0.008062, 0.7673) 
  )
lagrange_df %>% 
  knitr::kable(booktabs = TRUE, align = 'c') %>% 
  kable_styling() %>% 
  row_spec(1:3, color = "black", background = "#ceebcc", bold = TRUE) 
```

**Notes:** the Lagrange multiplier lags was significant for regressions modeling, obesity, hypertension and life-expectancy. None of the Lagrange multipliers were significant for self-reported health.

### **Final Model**

  Based on the linear regression assumptions and the spatial diagnostic tests, we concluded that we need to run **spatial lag models** for obesity,              hypertension, and life-expectancy and a **regular multivariable linear regression** for self-reported health (since none of the Lagrange tests were            significant we deduced that there was no need for spatial parameter adjustment). 

```{r, message = FALSE, warning = FALSE}
###Specify Spatial Lag Model for obesity
obesity_lag <- lagsarlm(obesity ~ garden_num + poverty, data = analysis_data_spatial, analysis_nbq_w, tol.solve = 1.0e-15)
obesity_lag_df <-
obesity_lag %>% 
  broom::tidy() 

###Specify Spatial Lag Model for hypertension
hypertension_lag <- lagsarlm(hypertension ~ garden_num + poverty, data = analysis_data_spatial, analysis_nbq_w, tol.solve = 1.0e-15)
hypertension_lag_df <-
hypertension_lag %>% 
  broom::tidy() 

###Specify Spatial Lag Model for life expectancy
life_expect_lag <- lagsarlm(life_expectancy ~ garden_num + poverty, data = analysis_data_spatial, analysis_nbq_w, tol.solve = 1.0e-15)
life_expect_lag_df <-
life_expect_lag %>% 
  broom::tidy() 

###Specify regular linear regression model for self-reported health
self_rep_lm <- lm(self_rep_health ~ garden_num + poverty, data = analysis_data_spatial)
self_rep_lm_df <-
self_rep_lm %>% 
  broom::tidy() 

rbind(obesity_lag_df, hypertension_lag_df, life_expect_lag_df, self_rep_lm_df) %>%
  knitr::kable() %>% 
    kable_styling() %>%
  pack_rows(index = c("Obesity" = 4, "Hypertension" = 4, "Life Expectancy" = 4, "Self Reported Health" = 3)) %>% 
  row_spec(3, color = "black", background = "#ceebcc") %>% 
  row_spec(7, color = "black", background = "#ceebcc") %>% 
  row_spec(11, color = "black", background = "#EBE4CC", bold = TRUE) %>% 
  row_spec(14, color = "black", background = "#ceebcc") 

```

**Notes:** "Rho": Indicates the spatial lag (there is no rho term in the self-reported health model because a spatial lag model was not run here). Alpha = 0.01 to account for Bonferroni Correction

#### Obesity Results

  There was no significant association at alpha equal to 0.01, between number of gardens and obesity

#### Hypertension Results

  There was no significant association at alpha equal to 0.01, between number of gardens and hypertension.

#### Life Expectancy Results

  For every one unit increase in the number of gardens, there is a **1.19 unit decrease** in percent of adults with hypertension in the district, at the 1%       level of significance.

#### Self Reported Health Results

  There was no significant association at alpha equal to 0.01, between number of gardens and self reported health.

### **Conclusions**

**Spatial Clustering**

 * Based on the Moran's I results, we can conclude that there is evidence of spatial clustering of gardens.
 * This means that the gardens are not randomly distributed across NYC, confirming our initial hypothesis that community gardens are not evenly dispersed spatially.
 
 **Final Model**
 
  * Since we ended up using 4 models to assess our research questions, we chose to *set alpha at 0.0125, using the Bonferroni Correction*
  * Interpret Betas!!!???
  
### **What to take away from this**

  We noticed that an increase in number of outcomes resulted in poorer overall health(higher proportions of obesity and hypertension, lower life                 expectancy). While these results are contrary to our initial hypotheses, upon reflection we do believe that these results accurately represent the             associations between community gardens and health in NYC. As part of community outreach programs, we believe that gardens may be prioritized to be             constructed in areas with low overall health to help improve health outcomes there. Therefore, more gardens would be built in these areas. A future            analysis could look at the associations between number of gardens and health in these communities after several years to see if adding gardens impacted        the overall health outcomes over time. 

