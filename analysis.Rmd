---
title: "Statistical Analysis"
output: 
  html_document:
    toc: true
    toc_float: true
---
  
```{r}
library(tidyverse)
library(sandwich)
library(spdep)
library(maptools)
library(rgdal)
library(spatialreg)
```

Load data and clean. Had to remove one community garden that didn't have any neighbors because was getting error when running the spatial regression.
```{r, message = FALSE, warning = FALSE, include = FALSE}
analysis_data <-
  read_csv("./data/final_df.csv") %>% 
  select(community_board, garden_name, obesity, hypertension, life_expectancy, self_rep_health, poverty, avg_rev_value, avg_tot_appropriated) %>% 
  mutate(duplicate = community_board, 
         spatial_id = community_board, 
         spatial_id = str_replace(spatial_id, "^M", "1"),
         spatial_id = str_replace(spatial_id, "^X", "2"),
         spatial_id = str_replace(spatial_id, "^B", "3"),
         spatial_id = str_replace(spatial_id, "^Q", "4"),
         spatial_id = str_replace(spatial_id, "^R", "5")
         ) %>% 
  separate(duplicate, c("boro", NA), sep = 1) %>% 
  mutate(
    spatial_id = as.numeric(spatial_id)
  )

num_gardens <-
  analysis_data %>% 
  drop_na(garden_name) %>% 
  group_by(community_board) %>% 
  summarize(garden_num = n())

unique_comboard <-
  analysis_data %>% 
  distinct(community_board, .keep_all = TRUE)

analysis_data_final <-
  left_join(unique_comboard, num_gardens, by = "community_board") %>% 
  select(-garden_name) %>% 
  replace_na(list(garden_num = 0)) %>% 
  mutate(
    log_garden_num = log(garden_num),
    boro_name = case_when(
      boro == "M" ~ "Manhattan",
      boro == "X" ~ "Bronx",
      boro == "B" ~ "Brooklyn",
      boro == "Q" ~ "Queens",
      boro == "R" ~ "Staten Island"
    )) %>% 
  filter(!spatial_id %in% c('414', '105', '106', '310', '315', '502'))
         
working <- getwd()
com_board_spdf <- readOGR(dsn = working, layer = "community_board_new")
com_board_spdf2 <- com_board_spdf[!com_board_spdf@data$boro_cd %in% c("414", "105", "106", "310", "315", "502"), ]
names(com_board_spdf)
analysis_data_spatial <- merge(com_board_spdf2, analysis_data_final, by.x = "boro_cd", by.y = "spatial_id")
```

### Building a model
Check linearity of predictor with outcome
Poverty, obesity, hypertension, life expectancy, and self-reported health are generally linearly associated with log of garden number. Transformed to log to see linear relationship but with assumed normal error and constant variance. 
```{r}
analysis_data_final %>% 
  ggplot(aes(x = garden_num, y = poverty)) +
  geom_point()

analysis_data_final %>% 
  ggplot(aes(x = garden_num, y = obesity)) +
  geom_point()

analysis_data_final %>% 
  ggplot(aes(x = garden_num, y = hypertension)) +
  geom_point()

analysis_data_final %>% 
  ggplot(aes(x = garden_num, y = life_expectancy)) +
  geom_point()

analysis_data_final %>% 
  ggplot(aes(x = garden_num, y = self_rep_health)) +
  geom_point()

analysis_data_final %>% 
  ggplot(aes(x = garden_num, y = avg_rev_value)) +
  geom_point()

analysis_data_final %>% 
  ggplot(aes(x = garden_num, y = avg_tot_appropriated)) +
  geom_point()
```

Check normal ish distribution of outcome - poverty, obesity, life expectancy, self-rep health I think ok to use because generally normal distribution. Hypertension is bimodal.
```{r}
analysis_data_final %>% 
  ggplot(aes(x = poverty)) +
  geom_density()

analysis_data_final %>% 
  ggplot(aes(x = obesity)) +
  geom_density()

analysis_data_final %>% 
  ggplot(aes(x = hypertension)) +
  geom_density()

analysis_data_final %>% 
  ggplot(aes(x = life_expectancy)) +
  geom_density()

analysis_data_final %>% 
  ggplot(aes(x = self_rep_health)) +
  geom_density()
```

Pick theoretical predictors: poverty as confounder, obesity and life expectancy as outcomes. 

Check spatial dependence (non-random distribution) of variables using Moran's I. All have significant Moran's I indicating spatial dependence which we should include in our model.  
```{r, eval = FALSE}

###Create a queen's neighborhood weight matrix using the poly2nb command.
analysis_nbq <- poly2nb(analysis_data_spatial)

###extract coordinates to plot the connectivity matrix for visualization.
coords <- coordinates(analysis_data_spatial)

###convert the neighborhood matrix into a list so that the connections between counties can be used in Moran's I test.
analysis_nbq_w <- nb2listw(analysis_nbq)

###Garden number
###Convert Exposure variable to z-form and then create the lag of that variable.
analysis_data_spatial@data$log_garden_num <- scale(analysis_data_spatial@data$log_garden_num)
analysis_data_spatial@data$lag_sQL <- lag.listw(analysis_nbq_w,analysis_data_spatial@data$log_garden_num)

### Lose spatial properties when we turn into data frame for analysis
analysis_sp_data <- as.data.frame(analysis_data_spatial)

###Run morans I test and plot the results.
moran.test(analysis_data_spatial@data$log_garden_num, listw = analysis_nbq_w, zero.policy = TRUE)
moran.plot(as.vector(analysis_data_spatial@data$log_garden_num), listw = analysis_nbq_w, 
           xlim = c(-2,4),ylim = c(-2,2),
                 main = "Moran's I = 0.1899, p-value = 0.0138", 
           xlab = "Garden Number", ylab = "Spatial Lag Number of Gardens", pch = 19)

###Poverty
###Convert Exposure variable to z-form and then create the lag of that variable.
analysis_data_spatial@data$poverty <- scale(analysis_data_spatial@data$poverty)
analysis_data_spatial@data$lag_sQL_p <- lag.listw(analysis_nbq_w,analysis_data_spatial@data$poverty)

### Lose spatial properties when we turn into data frame for analysis
analysis_sp_data <- as.data.frame(analysis_data_spatial)

###Run morans I test and plot the results.
moran.test(analysis_data_spatial@data$poverty, listw = analysis_nbq_w, zero.policy = TRUE)
moran.plot(as.vector(analysis_data_spatial@data$poverty), listw = analysis_nbq_w, 
           xlim = c(-2,4),ylim = c(-2,2),
                 main = "Moran's I = 0.4787, p-value < 0.0001", 
           xlab = "Poverty", ylab = "Spatial Lag Poverty", pch = 19)

###Obesity
###Convert outcome variable to z-form and then create the lag of that variable.
analysis_data_spatial@data$obesity <- scale(analysis_data_spatial@data$obesity)
analysis_data_spatial@data$lag_sQL_o <- lag.listw(analysis_nbq_w,analysis_data_spatial@data$obesity)

### Lose spatial properties when we turn into data frame for analysis
analysis_sp_data <- as.data.frame(analysis_data_spatial)

###Run morans I test and plot the results.
moran.test(analysis_data_spatial@data$obesity, listw = analysis_nbq_w, zero.policy = TRUE)
moran.plot(as.vector(analysis_data_spatial@data$obesity), listw = analysis_nbq_w, 
           xlim = c(-2,4),ylim = c(-2,2),
                 main = "Moran's I = 0.7075, p-value < 0.0001", 
           xlab = "Obesity", ylab = "Spatial Lag Obesity", pch = 19)

###Life Expectancy
###Convert outcome variable to z-form and then create the lag of that variable.
analysis_data_spatial@data$life_expectancy <- scale(analysis_data_spatial@data$life_expectancy)
analysis_data_spatial@data$lag_sQL_l <- lag.listw(analysis_nbq_w,analysis_data_spatial@data$life_expectancy)

### Lose spatial properties when we turn into data frame for analysis
analysis_sp_data <- as.data.frame(analysis_data_spatial)

###Run morans I test and plot the results.
moran.test(analysis_data_spatial@data$life_expectancy, listw = analysis_nbq_w, zero.policy = TRUE)
moran.plot(as.vector(analysis_data_spatial@data$life_expectancy), listw = analysis_nbq_w, 
           xlim = c(-2,4),ylim = c(-2,2),
                 main = "Moran's I = 0.5354, p-value < 0.0001", 
           xlab = "Life Expectancy", ylab = "Spatial Lag Life Expectancy", pch = 19)
```

Fit Preliminary Models: 
1. Life expectancy = log(garden_num) + poverty
2. Obesity = log(garden_num) + poverty

Test baseline linear models and do spatial diagnostics to choose appropriate spatial model. Need to confirm which exact spatial model to use, and whether any spatial related assumptions violated.
```{r, eval = FALSE}
###Test baseline linear model.
obesity_lm <- lm(obesity ~ garden_num + poverty, data = analysis_data_spatial)
summary(obesity_lm)
life_expectancy_lm <- lm(life_expectancy ~ log(garden_num) + poverty, data = analysis_data_spatial)
summary(life_expectancy_lm)

###Run Langrane Multiplier tests to identify the type of spatial regression model to run.
obesity.lagrange <- lm.LMtests(obesity_lm, analysis_nbq_w, test = c("LMerr","RLMerr","LMlag","RLMlag","SARMA"))
print(obesity.lagrange)
life_expectancy.lagrange <- lm.LMtests(life_expectancy_lm,analysis_nbq_w, test = c("LMerr","RLMerr","LMlag","RLMlag","SARMA"))
print(life_expectancy.lagrange)

### GLOBAL MODELS ###

###Specify Spatial Lag Model
htn.lag <- spatialreg::lagsarlm(hypertension ~ garden_num + poverty, data = analysis_data_spatial, health_nbq_w, tol.solve = 1.0e-15)
###Spatial error model 
htn.err <- spatialreg::errorsarlm(hypertension ~ garden_num + poverty, data = analysis_data_spatial, health_nbq_w, tol.solve = 1.0e-15)
###Mixed model (SARMA significant)
htn.sar <- spatialreg::lagsarlm(hypertension ~ garden_num + poverty, data = analysis_data_spatial, health_nbq_w, type = "mixed", tol.solve = 1.0e-15)

summary(htn.lag)
summary(htn.err)
summary(htn.sar)
```

Issues: All of our outcomes are not really linear with garden_num. They are more linear with log(garden_num), but when we do that there are a bunch of errors with the locations that have zero gardens, because log(0) is not a real number. But when I remove the districts with no gardens there are other errors because then not all the districts tough each other, which is necessary for the spatial model. Thoughts? 

### To do: 

Check spatial diagnostics & regular diagnostics of our models: 
-check residuals 
  - normally distributed  
  - equal variance  
  - not spatially correlated  
-check r^2 for model fit 
- Could make 2 model options & do cross validation, but not sure if possible b/c only have poverty as a possible confounder, none of the other variables make much sense.

Model output to visualize: 
- Table of betas and se
- plot the actual linear model over data points 


