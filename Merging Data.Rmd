---
title: "Data Cleaning and Merging"
date: "11/13/20"
output: github_document
---

```{r setup}
library(tidyverse)
library(readxl)
```

**Borough Codes**

* 1 - Manhattan (M)
* 2 - Bronx (x)
* 3 - Brooklyn (B)
* 4 - Queens (Q)
* 5 - Staten Island (R)


### [NYC Greenthumb Community Gardens](https://data.cityofnewyork.us/Environment/NYC-Greenthumb-Community-Gardens/ajxm-kzmj)

**Cleaning and tidying garden data**

```{r}
gardens = 
  read_csv("./data/nyc_community_gardens.csv") %>% 
  janitor::clean_names() %>% 
  mutate(
    community_board = replace(community_board, community_board == "N/A", NA)
  ) %>% 
  relocate(community_board) %>% 
  select(-prop_id,-census_tract, -bin, -bbl, -nta, -boro)

```


### Demographic and Community data

**Cleaning and tidying demographic data**
```{r}
demo = 
  read_xlsx("./data/health_profiles.xlsx",
  sheet = "CHP_all_data", skip = 1) %>% 
  janitor::clean_names() %>% 
  slice(-(1:6)) %>% 
  slice_head(n = 59) %>% 
  mutate(
    id = str_replace(id, "^1", "M"),
    id = str_replace(id, "^2", "X"),
    id = str_replace(id, "^3", "B"),
    id = str_replace(id, "^4", "Q"),
    id = str_replace(id, "^5", "R"),
    gentrification = replace(gentrification, gentrification == "n/a", NA),
    avertable_death = replace(avertable_death, avertable_death == "n/a", NA),
    avertable_death = replace(avertable_death, avertable_death == "^", NA)
  ) %>% 
  rename(community_board = id, not_complete_hs = edu_did_not_complete_hs, hs_some_college = edu_hs_grad_some_college, college_higher = edu_college_degree_and_higher) %>% 
  select(community_board:age65plus, on_time_hs_grad, not_complete_hs, hs_some_college, college_higher, poverty, unemployment, rent_burden, gentrification,
         avertable_death, assault_hosp)
```


### [Revised property value notices](https://data.cityofnewyork.us/City-Government/Revised-Notice-of-Property-Value-RNOPV-/8vgb-zm6e)

**Cleaning and tidying property data**

```{r}
property = 
  read_csv("./data/property_values.csv") %>% 
  janitor::clean_names() %>% drop_na(community_board) %>% 
  rename(old_community_board = community_board) %>% 
  mutate(
    boro_letter = case_when(
      borough == "MANHATTAN" ~ "M",
      borough == "BRONX" ~ "X",
      borough == "BROOKLYN" ~ "B",
      borough == "QUEENS" ~ "Q",
      borough == "STATEN IS" ~ "R"
    ),
    board_num = ifelse(nchar(old_community_board) == 1, paste0(0, old_community_board), old_community_board)
  ) %>% 
  unite("community_board", boro_letter, board_num, sep = "") %>% 
  relocate(community_board, old_community_board, borough) %>% 
  select(community_board, lot, tax_class, original_market_value, revised_market_value)
```

**Grouping values by community board**

```{r}
property_tidy = 
  property %>% 
  group_by(community_board) %>% 
  summarize(
    avg_org_value = mean(original_market_value, na.rm = TRUE),
    avg_rev_value = mean(revised_market_value, na.rm = TRUE),
    avg_lot = mean(lot, na.rm = TRUE),
    median_tax_class = median(tax_class, na.rm = TRUE)
  )
```
**Questions:**

* Should we take the mean or median of # of tax class? We could also round to nearest whole number after taking the mean
  

### [NYC OpenData](https://data.cityofnewyork.us/City-Government/Participatory-Budgeting-Project-Tracker/qm5f-frjb)

**Cleaning and tidying budget data**

```{r}
budget = 
  read_csv("./data/budget_tracker.csv") %>% 
  janitor::clean_names() %>% drop_na(community_board) %>% 
  rename(old_community_board = community_board) %>% 
  mutate(
    boro_letter = case_when(
      borough == "MANHATTAN" ~ "M",
      borough == "BRONX" ~ "X",
      borough == "BROOKLYN" ~ "B",
      borough == "QUEENS" ~ "Q",
      borough == "STATEN IS" ~ "R"
    ),
    board_num = ifelse(nchar(old_community_board) == 1, paste0(0, old_community_board), old_community_board)
  ) %>% 
  unite("community_board", boro_letter, board_num, sep = "") %>% 
  relocate(community_board, old_community_board, borough) %>% 
  select(community_board, project:subproject_cost, total_appropriated, number_of_subprojects, status_summary)

```

**Grouping values by community board**

```{r}
budget_tidy = 
  budget %>% 
  group_by(community_board) %>% 
  summarize(
    avg_ballot_price = mean(ballot_price, na.rm = TRUE),
    avg_subproj_cost = mean(subproject_cost, na.rm = TRUE),
    avg_tot_appropriated = mean(total_appropriated, na.rm = TRUE),
    median_num_subproj = median(number_of_subprojects, na.rm = TRUE)
  )

```
**Questions:**

* Should we take the mean or median of # of subprojects? We could also round to nearest whole number after taking the mean


### Merging method 1:
```{r}
with_grouping =
  left_join(gardens, demo, by = "community_board") %>% 
  left_join(., property_tidy, by = "community_board") %>% 
  left_join(., budget_tidy, by = "community_board")

# To see how many times a community board appears 
table(with_grouping$community_board)
```
**Notes:**

* This dataset contains 536 observations (the number of gardens in the garden dataset). 

* I grouped the the property value variables and budgeting information variables by community board so there was 1 observations per community board in the "property_tidy" and "budget_tidy" dataframes

* Let me know if anything looks off here


### Merging method 2:
```{r}
without_grouping = 
  left_join(gardens, demo, by = "community_board") %>% 
  left_join(., property, by = "community_board") %>% 
  left_join(., budget, by = "community_board")

# To see how many times a community board appears 
table(without_grouping$community_board)
```
**Notes:**

* This dataset contains over 1 million records because no grouping was done for the budget or property datasets 

* This dataset contains over 1 million records because no grouping was done for the budget or property datasets 

* Personally, I think that this creates a lot of extraneous information in our dataset. Since our project is aimed at looking at individual gardens, not properties or specific budgeting projects, I'm not sure this merging method makes sense

* **Isabel**, please correct me if I interpreted how you wanted to merge incorrectly.

